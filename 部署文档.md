### 目标
- 将项目升级至 Python 3.9+、Fabric 2.5.0、PostgreSQL 17，操作系统为 Linux CentOS 8（或 CentOS Stream 8）。

### 目录结构
- `proj/`：Celery 应用与任务
- `fabfile.py`：Fabric 2 任务（启动/停止 workers、批量入队、查询、清理）
- `requirements.txt`：Python 依赖

### 1. 系统准备（CentOS 8）
1) 基础工具
```bash
sudo dnf -y update
sudo dnf -y install git gcc gcc-c++ make openssl-devel libffi-devel bzip2-devel libpq-devel
```

2) 安装 Python 3.9（CentOS Stream 8）
```bash
sudo dnf -y module enable python39
sudo dnf -y module install python39
python3.9 -V
python3.9 -m venv venv
source venv/bin/activate
pip install --upgrade pip
```

3) 安装 RabbitMQ 与 Redis（可选：用 Docker 更简单）
- 使用系统服务（示例，实际以你环境为准）：
  - RabbitMQ（broker）：`amqp://guest:guest@localhost:5672//`
  - Redis（result backend）：`redis://localhost:6379/0`

4) 安装 PostgreSQL 17
```bash
# 官方 PGDG 源
sudo dnf -y install https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm
sudo dnf -y install postgresql17 postgresql17-server postgresql17-contrib
sudo /usr/pgsql-17/bin/postgresql-17-setup initdb
sudo systemctl enable --now postgresql-17

# 创建数据库与用户（示例）
sudo -u postgres psql -c "CREATE USER postgres WITH PASSWORD 'postgres' SUPERUSER;"
sudo -u postgres createdb messages -O postgres
```

5) 安装 Elasticsearch（建议 8.x）
- 略（根据官方文档安装）。
- 启动后默认地址：`http://localhost:9200`。

### 2. 项目配置
1) 克隆与安装依赖
```bash
git clone <your_repo>
cd celery-message-processing
source ../venv/bin/activate    # 若不在同一目录，请调整路径
pip install -r requirements.txt
```

2) 环境变量（可选覆盖默认值）
```bash
export BROKER_URL=amqp://guest:guest@localhost:5672//
export RESULT_BACKEND=redis://localhost:6379/0
export DB_URL=postgresql+psycopg2://postgres:postgres@localhost:5432/messages
export ES_URL=http://localhost:9200
```

### 3. 启动 Celery workers
```bash
fab workers --action=start
# 其他操作：
fab workers --action=restart
fab workers --action=stop
```

### 4. 处理数据
- 单个文件：
```bash
fab process_one --filename=/path/to/mail.eml
```
- 目录批量：
```bash
fab process --path=/path/to/maildir
```

### 5. 查看结果
- PostgreSQL：
```bash
fab query_db --query="SELECT COUNT(*) FROM messages;"
```
- Elasticsearch：
```bash
fab query_es --query="subject:meeting"
```

### 6. 清理
```bash
fab purge
```

### 7. 变更说明（与旧版差异）
- Python 升级到 3.9+；源码已移除 Python2 `print` 语法。
- Fabric 从 1.x 迁移至 2.5.0：
  - 使用 `@task` 装饰器与 `Context` 对象，命令示例改为 `fab task --arg=value`。
  - `local()` 改为 `c.run()`。
- 数据库从 MySQL 切换为 PostgreSQL 17：
  - 连接串通过 `DB_URL` 配置，默认 `postgresql+psycopg2://postgres:postgres@localhost:5432/messages`。
  - Fabric 中的数据库查询与清理命令改用 `psql`。
- Celery 兼容 Celery 5：
  - 配置项使用 `result_expires` 等键；支持通过环境变量覆盖 broker/backend。
- Elasticsearch 写入兼容 7/8：
  - 优先使用 `document=` 参数，若不支持则回退为 `body=`。

### 8. 运行验证
1) 启动依赖（RabbitMQ、Redis、PostgreSQL、Elasticsearch）
2) 安装依赖并设置环境变量
3) 启动 workers：`fab workers --action=start`
4) 处理一个示例邮件文件：`fab process_one --filename=./sample.eml`
5) 校验：
   - `fab query_db --query="SELECT COUNT(*) FROM messages;"`
   - `fab query_es --query="*:*"`

若遇到问题，请检查：
- 端口与凭据是否正确（BROKER_URL、RESULT_BACKEND、DB_URL、ES_URL）。
- PostgreSQL 权限与表是否已自动创建（首次运行会自动创建）。
